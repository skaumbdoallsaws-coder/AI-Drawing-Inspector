{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://continentalmachines.com/schemas/drawing-evidence/v1.1.1",
  "title": "DrawingEvidence",
  "description": "Evidence extracted from engineering drawing by vision pipeline. Locked version 1.1.1.",
  "type": "object",

  "$comment": "LOCKED SCHEMA v1.1.1 - Do not modify without version bump. Changes from v1.1.0: (1) bbox explicitly optional, (2) page indexing locked with pageIndex0 option, (3) soft validation rules added, (4) quantity semantics clarified with quantityRaw.",

  "$defs": {
    "_metadata": {
      "description": "Schema metadata - not used in validation",
      "schemaVersion": "1.1.1",
      "schemaDate": "2026-01-26",
      "canonicalFormat": {
        "diameterSymbol": "\u00f8",
        "diameterSymbolName": "LATIN SMALL LETTER O WITH STROKE (U+00F8)",
        "degreeSymbol": "\u00b0",
        "lengthUnit": "mm",
        "angleUnit": "deg",
        "decimalPlaces": {
          "diameter": 2,
          "depth": 1,
          "radius": 2,
          "angle": 0
        },
        "examples": {
          "hole_thru": "\u00f812.70mm THRU",
          "hole_blind": "\u00f812.70mm x 25.4mm DEEP",
          "hole_qty": "\u00f812.70mm THRU (4X)",
          "thread": "M6x1.0 x 12mm DEEP",
          "fillet": "Fillet: R0.76mm",
          "chamfer": "Chamfer: 0.76mm x 45\u00b0"
        }
      },
      "pageIndexingConvention": {
        "description": "Page numbering uses 1-indexed convention (first page = 1). For PDF libraries that use 0-indexed, use pageIndex0.",
        "page": "1-indexed (human-readable, matches PDF page labels)",
        "pageIndex0": "0-indexed (for programmatic use with pdf-lib, PyMuPDF, etc.)",
        "conversionRule": "pageIndex0 = page - 1"
      },
      "quantitySemantics": {
        "description": "Flat quantity fields are the SINGLE SOURCE OF TRUTH (no quantityInfo object)",
        "sourceOfTruth": "Flat fields: quantity, plcs, quantityRaw, isTypical",
        "quantity": "Resolved integer count (always >= 1, default 1)",
        "plcs": "Explicit PLCS/PLACES count when that notation was used (null otherwise)",
        "quantityRaw": "Original token exactly as written: '(4X)', '4 HOLES', '2 PLCS', 'TYP' (null if not specified)",
        "isTypical": "True if TYP/TYPICAL present (null otherwise)",
        "examples": [
          { "rawText": "4X \u00f8.500 THRU", "quantity": 4, "quantityRaw": "4X", "plcs": null, "isTypical": null },
          { "rawText": "\u00f8.500 (4 HOLES)", "quantity": 4, "quantityRaw": "(4 HOLES)", "plcs": null, "isTypical": null },
          { "rawText": "\u00f8.500 2 PLCS", "quantity": 2, "quantityRaw": "2 PLCS", "plcs": 2, "isTypical": null },
          { "rawText": "R.030 TYP", "quantity": 1, "quantityRaw": "TYP", "plcs": null, "isTypical": true },
          { "rawText": "\u00f8.500 THRU", "quantity": 1, "quantityRaw": null, "plcs": null, "isTypical": null }
        ]
      }
    },

    "_softValidationRules": {
      "description": "Soft validation rules per calloutType. These generate WARNINGS, not errors. Used to flag weak extractions for review.",
      "rules": {
        "Hole": {
          "shouldHave": ["hole.diameterMm", "hole.isThrough OR hole.depthMm"],
          "warnIf": {
            "missingDiameter": "hole.diameterMm is null",
            "ambiguousDepth": "hole.isThrough is null AND hole.depthMm is null"
          }
        },
        "TappedHole": {
          "shouldHave": ["thread", "thread.standard", "thread.nominalMm"],
          "warnIf": {
            "missingThread": "thread is null or empty",
            "missingThreadSpec": "thread.standard is null OR thread.nominalMm is null",
            "missingPitch": "thread.pitch is null AND thread.tpi is null"
          }
        },
        "Counterbore": {
          "shouldHave": ["hole.diameterMm", "hole.counterboreDiameterMm", "hole.counterboreDepthMm"],
          "warnIf": {
            "missingCbore": "hole.counterboreDiameterMm is null"
          }
        },
        "Countersink": {
          "shouldHave": ["hole.diameterMm", "hole.countersinkDiameterMm OR hole.countersinkAngle"],
          "warnIf": {
            "missingCsink": "hole.countersinkDiameterMm is null AND hole.countersinkAngle is null"
          }
        },
        "Fillet": {
          "shouldHave": ["fillet.radiusMm"],
          "warnIf": {
            "missingRadius": "fillet.radiusMm is null"
          }
        },
        "Chamfer": {
          "shouldHave": ["chamfer.distance1Mm", "chamfer.angleDegrees OR chamfer.distance2Mm"],
          "warnIf": {
            "missingDistance": "chamfer.distance1Mm is null",
            "ambiguousType": "chamfer.chamferType is null"
          }
        },
        "Slot": {
          "shouldHave": ["slot.widthMm", "slot.lengthMm"],
          "warnIf": {
            "missingDimensions": "slot.widthMm is null OR slot.lengthMm is null"
          }
        },
        "LinearDimension": {
          "shouldHave": ["dimension.valueMm OR dimension.valueInches"],
          "warnIf": {
            "missingValue": "dimension.valueMm is null AND dimension.valueInches is null"
          }
        },
        "DiameterDimension": {
          "shouldHave": ["dimension.valueMm OR dimension.valueInches"],
          "warnIf": {
            "missingValue": "dimension.valueMm is null AND dimension.valueInches is null"
          }
        },
        "RadiusDimension": {
          "shouldHave": ["dimension.valueMm OR dimension.valueInches"],
          "warnIf": {
            "missingValue": "dimension.valueMm is null AND dimension.valueInches is null"
          }
        },
        "AngleDimension": {
          "shouldHave": ["dimension.valueDegrees"],
          "warnIf": {
            "missingAngle": "dimension.valueDegrees is null"
          }
        },
        "GdtPosition": {
          "shouldHave": ["gdt.toleranceMm", "gdt.datumRefs"],
          "warnIf": {
            "missingTolerance": "gdt.toleranceMm is null",
            "missingDatums": "gdt.datumRefs is null or empty"
          }
        },
        "Datum": {
          "shouldHave": ["rawText matches /^-?[A-Z]-?$/"],
          "warnIf": {
            "invalidFormat": "rawText does not look like a datum label"
          }
        },
        "SurfaceFinish": {
          "shouldHave": ["surfaceFinish.roughnessRa"],
          "warnIf": {
            "missingRoughness": "surfaceFinish.roughnessRa is null"
          }
        }
      },
      "globalWarnings": {
        "lowConfidence": "confidence < 0.5",
        "noLocation": "location is null",
        "noCanonical": "canonical is null AND calloutType is not Unknown/Note"
      }
    },

    "OcrField": {
      "type": "object",
      "description": "OCR-extracted field with SW fallback. All properties nullable for OCR resilience.",
      "properties": {
        "ocrValue": {
          "type": ["string", "null"],
          "description": "Value as read by OCR (null if unreadable or not found)"
        },
        "swFallback": {
          "type": ["string", "null"],
          "description": "Value from SolidWorks model (authoritative fallback)"
        },
        "resolved": {
          "type": ["string", "null"],
          "description": "Final resolved value: ocrValue if confident, else swFallback, else null"
        },
        "ocrConfidence": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 1,
          "description": "OCR confidence (null if not extracted)"
        },
        "source": {
          "type": ["string", "null"],
          "enum": ["ocr", "sw_fallback", "both_match", "ocr_override", "unresolved", null],
          "description": "Which source provided resolved value (null if completely unresolved)"
        },
        "location": {
          "oneOf": [
            { "$ref": "#/$defs/Location" },
            { "type": "null" }
          ],
          "description": "Where this field was found on drawing. OPTIONAL - null if location unknown."
        }
      },
      "additionalProperties": false
    },

    "Identity": {
      "type": "object",
      "description": "Part identity - all fields use OcrField wrapper for OCR tolerance",
      "properties": {
        "partNumber": { "$ref": "#/$defs/OcrField" },
        "revision": { "$ref": "#/$defs/OcrField" },
        "description": { "$ref": "#/$defs/OcrField" },
        "material": { "$ref": "#/$defs/OcrField" },
        "finish": { "$ref": "#/$defs/OcrField" },
        "drawnBy": { "$ref": "#/$defs/OcrField" },
        "checkedBy": { "$ref": "#/$defs/OcrField" },
        "approvedBy": { "$ref": "#/$defs/OcrField" },
        "date": { "$ref": "#/$defs/OcrField" },
        "scale": { "$ref": "#/$defs/OcrField" },
        "sheet": { "$ref": "#/$defs/OcrField" },
        "units": {
          "type": ["string", "null"],
          "enum": ["INCH", "MM", "DUAL", null],
          "description": "Drawing units detected from title block or dimensions"
        }
      },
      "additionalProperties": false
    },

    "Location": {
      "type": "object",
      "description": "Location on drawing with page/view anchoring. bbox is OPTIONAL - may have page but no coordinates.",
      "required": ["page"],
      "properties": {
        "page": {
          "type": "integer",
          "minimum": 1,
          "description": "1-INDEXED page number (first page = 1). For human readability and PDF page labels."
        },
        "pageIndex0": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "0-INDEXED page number (first page = 0). For programmatic use with PDF libraries. Should equal (page - 1)."
        },
        "sheetName": {
          "type": ["string", "null"],
          "description": "Sheet name (e.g., 'SHEET 1 OF 3')"
        },
        "viewId": {
          "type": ["string", "null"],
          "description": "Unique view identifier assigned by extractor"
        },
        "viewName": {
          "type": ["string", "null"],
          "description": "View label as shown on drawing (e.g., 'SECTION A-A')"
        },
        "viewType": {
          "type": ["string", "null"],
          "enum": ["Front", "Top", "Right", "Left", "Bottom", "Back", "Isometric", "Section", "Detail", "Auxiliary", "Unknown", null]
        },
        "bbox": {
          "oneOf": [
            { "$ref": "#/$defs/BoundingBox" },
            { "type": "null" }
          ],
          "description": "OPTIONAL bounding box. Null when we know the page but not exact coordinates (e.g., title block field without OCR bbox)."
        }
      },
      "additionalProperties": false
    },

    "BoundingBox": {
      "type": "object",
      "description": "Normalized bounding box (0-1 coordinates, origin top-left). x,y required; width,height optional.",
      "required": ["x", "y"],
      "properties": {
        "x": { "type": "number", "minimum": 0, "maximum": 1, "description": "Left edge, 0=left margin, 1=right margin" },
        "y": { "type": "number", "minimum": 0, "maximum": 1, "description": "Top edge, 0=top margin, 1=bottom margin" },
        "width": { "type": ["number", "null"], "minimum": 0, "maximum": 1, "description": "OPTIONAL width (null if unknown)" },
        "height": { "type": ["number", "null"], "minimum": 0, "maximum": 1, "description": "OPTIONAL height (null if unknown)" }
      },
      "additionalProperties": false
    },

    "ViewInfo": {
      "type": "object",
      "description": "Detected drawing view",
      "required": ["viewId", "page"],
      "properties": {
        "viewId": { "type": "string" },
        "viewName": { "type": ["string", "null"] },
        "viewType": {
          "type": ["string", "null"],
          "enum": ["Front", "Top", "Right", "Left", "Bottom", "Back", "Isometric", "Section", "Detail", "Auxiliary", "Unknown", null]
        },
        "page": { "type": "integer", "minimum": 1, "description": "1-indexed page number" },
        "pageIndex0": { "type": ["integer", "null"], "minimum": 0, "description": "0-indexed page number" },
        "bbox": {
          "oneOf": [
            { "$ref": "#/$defs/BoundingBox" },
            { "type": "null" }
          ],
          "description": "OPTIONAL view bounding box"
        },
        "scale": { "type": ["string", "null"] },
        "parentViewId": { "type": ["string", "null"] }
      },
      "additionalProperties": false
    },

    "Callout": {
      "type": "object",
      "description": "Unified callout discriminated by calloutType",
      "required": ["calloutType", "rawText"],
      "properties": {
        "calloutType": {
          "type": "string",
          "enum": [
            "Hole", "TappedHole", "Counterbore", "Countersink",
            "Fillet", "Chamfer",
            "Slot",
            "LinearDimension", "RadiusDimension", "DiameterDimension", "AngleDimension",
            "GdtPosition", "GdtFlatness", "GdtPerpendicularity", "GdtParallelism",
            "GdtConcentricity", "GdtCircularity", "GdtCylindricity",
            "GdtProfileLine", "GdtProfileSurface", "GdtRunout", "GdtTotalRunout",
            "Datum",
            "SurfaceFinish",
            "Weld",
            "BendRadius", "BendAngle",
            "Note", "Unknown"
          ]
        },
        "rawText": {
          "type": "string",
          "description": "Original OCR text exactly as read"
        },
        "canonical": {
          "type": ["string", "null"],
          "description": "Normalized form for matching. Uses \u00f8 (U+00F8) for diameter. Null if normalization failed."
        },
        "confidence": {
          "type": ["number", "null"],
          "minimum": 0,
          "maximum": 1
        },
        "location": {
          "oneOf": [
            { "$ref": "#/$defs/Location" },
            { "type": "null" }
          ],
          "description": "OPTIONAL location on drawing"
        },
        "quantity": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "Resolved count (always >= 1). SOURCE OF TRUTH for quantity."
        },
        "plcs": {
          "type": ["integer", "null"],
          "minimum": 1,
          "description": "Explicit PLCS/PLACES count when that notation was used. Null otherwise."
        },
        "quantityRaw": {
          "type": ["string", "null"],
          "description": "Original quantity token exactly as written: '(4X)', '4 HOLES', '2 PLCS', 'TYP'. Null if not specified."
        },
        "isTypical": {
          "type": ["boolean", "null"],
          "description": "True if TYP/TYPICAL present (implies multiple unspecified instances). Null otherwise."
        },
        "validationWarnings": {
          "type": ["array", "null"],
          "items": { "type": "string" },
          "description": "Soft validation warnings for this callout (e.g., 'missingDiameter', 'lowConfidence')"
        },
        "hole": { "$ref": "#/$defs/HoleData" },
        "fillet": { "$ref": "#/$defs/FilletData" },
        "chamfer": { "$ref": "#/$defs/ChamferData" },
        "slot": { "$ref": "#/$defs/SlotData" },
        "dimension": { "$ref": "#/$defs/DimensionData" },
        "gdt": { "$ref": "#/$defs/GdtData" },
        "thread": { "$ref": "#/$defs/ThreadData" },
        "surfaceFinish": { "$ref": "#/$defs/SurfaceFinishData" },
        "weld": { "$ref": "#/$defs/WeldData" },
        "sheetMetal": { "$ref": "#/$defs/SheetMetalData" }
      },
      "additionalProperties": false
    },

    "HoleData": {
      "type": "object",
      "description": "Hole-specific extracted data. See _softValidationRules for expected fields per calloutType.",
      "properties": {
        "diameterMm": { "type": ["number", "null"] },
        "diameterInches": { "type": ["number", "null"] },
        "diameterRaw": { "type": ["string", "null"], "description": "As written: '.500', '1/2', '12.7'" },
        "depthMm": { "type": ["number", "null"] },
        "depthInches": { "type": ["number", "null"] },
        "depthRaw": { "type": ["string", "null"] },
        "isThrough": { "type": ["boolean", "null"] },
        "counterboreDiameterMm": { "type": ["number", "null"] },
        "counterboreDepthMm": { "type": ["number", "null"] },
        "countersinkDiameterMm": { "type": ["number", "null"] },
        "countersinkAngle": { "type": ["number", "null"], "description": "Countersink angle in degrees (typically 82 or 90)" }
      },
      "additionalProperties": false
    },

    "ThreadData": {
      "type": "object",
      "description": "Thread specification. TappedHole callouts SHOULD include this (soft validation warning if missing).",
      "properties": {
        "rawText": { "type": ["string", "null"], "description": "Thread callout as written: 'M6x1.0', '1/4-20 UNC'" },
        "standard": {
          "type": ["string", "null"],
          "enum": ["Metric", "UNC", "UNF", "NPT", "BSP", "ACME", "Unknown", null]
        },
        "nominalMm": { "type": ["number", "null"], "description": "Thread major diameter in mm" },
        "pitch": { "type": ["number", "null"], "description": "Thread pitch in mm (for metric threads)" },
        "tpi": { "type": ["integer", "null"], "description": "Threads per inch (for inch threads)" },
        "class": { "type": ["string", "null"], "description": "Thread class: '6H', '2B', etc." },
        "depthMm": { "type": ["number", "null"], "description": "Thread depth (may differ from hole depth)" }
      },
      "additionalProperties": false
    },

    "FilletData": {
      "type": "object",
      "properties": {
        "radiusMm": { "type": ["number", "null"] },
        "radiusInches": { "type": ["number", "null"] },
        "radiusRaw": { "type": ["string", "null"] }
      },
      "additionalProperties": false
    },

    "ChamferData": {
      "type": "object",
      "properties": {
        "chamferType": {
          "type": ["string", "null"],
          "enum": ["AngleDistance", "DistanceDistance", "Unknown", null]
        },
        "distance1Mm": { "type": ["number", "null"] },
        "distance2Mm": { "type": ["number", "null"] },
        "angleDegrees": { "type": ["number", "null"] }
      },
      "additionalProperties": false
    },

    "SlotData": {
      "type": "object",
      "properties": {
        "widthMm": { "type": ["number", "null"] },
        "lengthMm": { "type": ["number", "null"] },
        "depthMm": { "type": ["number", "null"] },
        "isThrough": { "type": ["boolean", "null"] },
        "endType": {
          "type": ["string", "null"],
          "enum": ["Round", "Square", "Mixed", "Unknown", null]
        }
      },
      "additionalProperties": false
    },

    "DimensionData": {
      "type": "object",
      "properties": {
        "valueMm": { "type": ["number", "null"] },
        "valueInches": { "type": ["number", "null"] },
        "valueDegrees": { "type": ["number", "null"] },
        "valueRaw": { "type": ["string", "null"] },
        "tolerance": {
          "type": ["object", "null"],
          "properties": {
            "type": {
              "type": ["string", "null"],
              "enum": ["Bilateral", "Unilateral", "Limit", "Basic", "Reference", null]
            },
            "upperMm": { "type": ["number", "null"] },
            "lowerMm": { "type": ["number", "null"] },
            "rawText": { "type": ["string", "null"] }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "GdtData": {
      "type": "object",
      "properties": {
        "characteristic": {
          "type": ["string", "null"],
          "enum": [
            "Position", "Concentricity", "Symmetry",
            "Parallelism", "Perpendicularity", "Angularity",
            "Flatness", "Straightness", "Circularity", "Cylindricity",
            "ProfileLine", "ProfileSurface",
            "CircularRunout", "TotalRunout",
            null
          ]
        },
        "toleranceMm": { "type": ["number", "null"] },
        "materialCondition": {
          "type": ["string", "null"],
          "enum": ["MMC", "LMC", "RFS", null]
        },
        "datumRefs": {
          "type": ["array", "null"],
          "items": {
            "type": "object",
            "properties": {
              "datum": { "type": "string" },
              "materialCondition": { "type": ["string", "null"] }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },

    "SurfaceFinishData": {
      "type": "object",
      "properties": {
        "roughnessRa": { "type": ["number", "null"] },
        "roughnessUnit": {
          "type": ["string", "null"],
          "enum": ["microinch", "micrometer", null]
        },
        "machiningRequired": { "type": ["boolean", "null"] },
        "layDirection": { "type": ["string", "null"] }
      },
      "additionalProperties": false
    },

    "WeldData": {
      "type": "object",
      "properties": {
        "weldType": {
          "type": ["string", "null"],
          "enum": ["Fillet", "Groove", "Plug", "Spot", "Seam", "Unknown", null]
        },
        "size": { "type": ["string", "null"] },
        "length": { "type": ["string", "null"] },
        "pitch": { "type": ["string", "null"] },
        "allAround": { "type": ["boolean", "null"] },
        "fieldWeld": { "type": ["boolean", "null"] }
      },
      "additionalProperties": false
    },

    "SheetMetalData": {
      "type": "object",
      "properties": {
        "bendRadiusMm": { "type": ["number", "null"] },
        "bendAngleDegrees": { "type": ["number", "null"] },
        "kFactor": { "type": ["number", "null"] },
        "thicknessMm": { "type": ["number", "null"] }
      },
      "additionalProperties": false
    },

    "Note": {
      "type": "object",
      "required": ["rawText"],
      "properties": {
        "rawText": { "type": "string" },
        "noteType": {
          "type": ["string", "null"],
          "enum": ["General", "Material", "Finish", "Process", "Tolerance", "Reference", "Unknown", null]
        },
        "location": {
          "oneOf": [
            { "$ref": "#/$defs/Location" },
            { "type": "null" }
          ]
        },
        "confidence": { "type": ["number", "null"], "minimum": 0, "maximum": 1 }
      },
      "additionalProperties": false
    },

    "ValidationSummary": {
      "type": "object",
      "description": "Summary of soft validation results",
      "properties": {
        "totalCallouts": { "type": "integer", "minimum": 0 },
        "calloutsWithWarnings": { "type": "integer", "minimum": 0 },
        "warningCounts": {
          "type": "object",
          "additionalProperties": { "type": "integer" },
          "description": "Count of each warning type: { 'missingDiameter': 2, 'lowConfidence': 5 }"
        },
        "lowConfidenceCount": { "type": "integer", "minimum": 0 },
        "noLocationCount": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": false
    }
  },

  "required": ["schemaVersion", "extractionTime", "sourceFile"],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "1.1.1",
      "description": "Must be exactly '1.1.1' for this schema version"
    },
    "extractionTime": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of extraction"
    },
    "sourceFile": {
      "type": "string",
      "description": "Path or identifier of source PDF/image"
    },
    "pageCount": {
      "type": ["integer", "null"],
      "minimum": 1
    },
    "overallConfidence": {
      "type": ["number", "null"],
      "minimum": 0,
      "maximum": 1,
      "description": "Aggregate extraction confidence"
    },
    "identity": {
      "$ref": "#/$defs/Identity",
      "description": "Part identity - nullable fields with SW fallback"
    },
    "foundCallouts": {
      "type": "array",
      "items": { "$ref": "#/$defs/Callout" },
      "description": "Unified array of all extracted callouts"
    },
    "foundNotes": {
      "type": "array",
      "items": { "$ref": "#/$defs/Note" },
      "description": "General notes and annotations"
    },
    "views": {
      "type": "array",
      "items": { "$ref": "#/$defs/ViewInfo" },
      "description": "Drawing views detected on each page"
    },
    "validationSummary": {
      "$ref": "#/$defs/ValidationSummary",
      "description": "Summary of soft validation warnings"
    }
  },
  "additionalProperties": false
}
