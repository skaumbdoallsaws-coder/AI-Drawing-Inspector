================================================================================
AI ENGINEERING DRAWING INSPECTOR - PROJECT RECAP
================================================================================
Date: January 20, 2026 (Updated)
Repository: https://github.com/skaumbdoallsaws-coder/AI-Drawing-Inspector
Main File: ai_inspector_final_fixed.ipynb

================================================================================
PROJECT OVERVIEW
================================================================================

This project is an AI-powered engineering drawing inspection system that:
1. Reads PDF engineering drawings using VLM-based OCR (LightOnOCR-2)
2. Checks for assembly compatibility issues (Imperial vs Metric mismatches)
3. Suggests GD&T improvements based on ASME Y14.5 standards

The system uses:
- Qwen2-VL-7B-Instruct (4-bit quantized, ~4GB VRAM) for vision + reasoning
- LightOnOCR-2-1B (~2GB VRAM) for structured text extraction from drawings
- CLIP embeddings for RAG retrieval of ASME standard pages
- Part context from SolidWorks CAD assembly (verified mating relationships)

================================================================================
RECENT CHANGES (January 20, 2026)
================================================================================

1. REPLACED TESSERACT WITH LIGHTONOCR-2
   - LightOnOCR-2 is a Vision-Language Model that understands document structure
   - Outputs clean Markdown with tables (better for title blocks, rotated text)
   - Requires transformers installed from source

2. SWITCHED FROM QWEN2-VL-72B TO QWEN2-VL-7B
   - 72B model had quantization issues (loading full precision, 147GB download)
   - 7B model is more manageable: ~14GB download, ~4GB VRAM in 4-bit
   - Still capable for drawing inspection tasks

3. ADDED HUGGINGFACE TOKEN SUPPORT
   - Uses Colab Secrets: userdata.get('HF_TOKEN')
   - Set HF_TOKEN in Colab Secrets (key icon in left sidebar)

4. EXTRACTED REAL MATING DATA FROM SOLIDWORKS
   - Created VBA macros to extract assembly tree and mates from CAD
   - Generated verified context databases from 046-935.SLDASM
   - 162 components, 44 unique parts, 18 assemblies with real PN mappings

5. REORGANIZED PROJECT DIRECTORY
   - old_manual_data/    - Previous manual extraction (242 parts)
   - old_scripts/        - Previous Python scripts
   - old_notebooks/      - Previous notebook versions
   - solidworks_tools/   - SW extraction macros

================================================================================
SOLIDWORKS DATA EXTRACTION
================================================================================

NEW CONTEXT DATABASES (from CAD, verified):
- sw_parts_db.json         - 44 unique parts with old/new PN mapping
- sw_assemblies_db.json    - 18 assemblies
- sw_mating_context.json   - Part -> sibling relationships
- sw_structure.json        - Assembly hierarchy
- 046-935_mates.txt        - Actual CAD mate constraints

SOLIDWORKS EXTRACTION TOOLS (in solidworks_tools/):
- ExtractMates_code.txt         - VBA macro to extract mates
- ExtractFullTree_v2_code.txt   - VBA macro to extract full tree + properties
- parse_sw_tree_v2.py           - Python parser for tree output

HOW TO EXTRACT FROM SOLIDWORKS:
1. Open assembly in SolidWorks
2. Tools > Macro > New
3. Paste code from ExtractFullTree_v2_code.txt
4. Run (F5)
5. Output saved next to assembly file
6. Run parse_sw_tree_v2.py to generate JSON databases

================================================================================
TWO-STAGE INSPECTION ARCHITECTURE
================================================================================

STAGE 1: THE GATEKEEPER (Mismatch Detection)
--------------------------------------------
- Function: inspect_drawing_universal()
- Purpose: Strict pass/fail check for physical assembly compatibility
- Checks: Imperial vs Metric conflicts, missing specifications
- RAG: DISABLED (for token efficiency)
- Output: Truth table with YES/NO/NOT FOUND for each mating part

STAGE 2: THE CONSULTANT (Improvement Suggestions)
-------------------------------------------------
- Function: suggest_improvements_stage2()
- Purpose: Qualitative GD&T improvement recommendations
- Runs: ONLY if Stage 1 passes
- RAG: ENABLED (retrieves ASME Y14.5 standard pages)
- Output: Missing tolerances, improvement suggestions, priority ranking

MASTER PIPELINE: run_full_inspection()
--------------------------------------
- Runs Stage 1, then Stage 2 (if Stage 1 passes)
- Returns comprehensive JSON report
- Final verdicts: PASS_WITH_SUGGESTIONS, FAIL, ERROR

================================================================================
KEY FUNCTIONS
================================================================================

1. inspect_drawing_universal(pdf_path)
   - Stage 1 only (Gatekeeper)
   - Returns truth table comparing mating parts vs drawing specs

2. suggest_improvements_stage2(pdf_path, context_data, ocr_text_list)
   - Stage 2 only (Consultant)
   - Requires context_data dict and OCR text from Stage 1
   - Uses Smart RAG queries based on part type

3. run_full_inspection(pdf_path)
   - Master pipeline: Stage 1 + Stage 2
   - Automatically handles flow control

4. get_drawing_text_ocr(image_input)
   - Runs LightOnOCR-2 on drawing
   - Returns structured text as list of lines

5. run_lighton_ocr(img)
   - Production OCR function
   - Alias: run_tesseract_ocr (for backwards compatibility)

6. parse_verdict(response_text)
   - Parses truth table to determine PASS/FAIL
   - Counts YES/NO in response

================================================================================
NOTEBOOK CELL STRUCTURE (Streamlined - 21 cells)
================================================================================

SECTION 1: SETUP
- Cell 2 (1A): Install Dependencies + HuggingFace Login
- Cell 3 (1B): Import Libraries

SECTION 2: LOAD MODELS
- Cell 5 (2A): Load LightOnOCR-2 (OCR model - load first, smaller)
- Cell 6 (2B): Load Qwen2-VL-7B (Reasoning model - load second)

SECTION 3: CONTEXT DATABASES
- Cell 7 (3A): Upload Configuration Files
- Cell 8 (3B): Load Part Context Databases
- Cell 10 (3E): Load RAG Index & Visual Database

SECTION 4: HELPER FUNCTIONS
- Cell 12 (4A): Core Helper Functions
- Cell 13 (4B): Model Query Function
- Cell 14 (4C): RAG Retrieval Function
- Cell 15 (4D): Production Pipeline Helpers (LightOnOCR-2)

SECTION 5: INSPECTION FUNCTIONS
- Cell 17 (5B): inspect_drawing_universal() - Stage 1
- Cell 18 (5D): run_full_inspection() - Master Pipeline

SECTION 6: RUN INSPECTION
- Cell 20: Upload and inspect single PDF

================================================================================
REQUIRED FILES
================================================================================

Configuration Files (upload as ZIP or individually):
1. sw_mating_context.json - Part context from SolidWorks (NEW)
2. sw_parts_db.json - Part number mappings from SolidWorks (NEW)
3. asme_visual_index.pkl - CLIP embeddings for ASME standard pages
4. rag_visual_db.zip - Folder of ASME standard page images (294 images)

Legacy files (in old_manual_data/, still usable):
- 400S_file_part_mapping.json - Maps filenames to part numbers
- 400S_detailed_structure_fixed.json - Part context from manual

================================================================================
HOW TO RUN (After Computer Restart)
================================================================================

1. Open Google Colab
2. File > Open notebook > GitHub
3. Select: skaumbdoallsaws-coder/AI-Drawing-Inspector
4. Open: ai_inspector_final_fixed.ipynb

5. Set HuggingFace Token:
   - Click key icon (Secrets) in left sidebar
   - Add: Name = HF_TOKEN, Value = your token
   - Toggle "Notebook access" ON

6. Run cells in order:
   - Cell 2: Install dependencies + HF login
   - Cell 3: Import libraries
   - Cell 5: Load LightOnOCR-2 (~2GB, fast)
   - Cell 6: Load Qwen2-VL-7B (~14GB download, ~4GB VRAM)
   - Cells 7-10: Load context databases
   - Cells 12-15: Load helper functions
   - Cells 17-18: Load inspection functions
   - Cell 20: Run test (upload a PDF)

================================================================================
TYPICAL OUTPUT
================================================================================

============================================================
UNIVERSAL INSPECTION: HEAD CASTING
============================================================
[1/3] Reading Drawing (LightOnOCR-2)...
  > Evidence: 54 relevant lines found.
[2/3] Generating Dynamic Truth Table...
[3/3] Running inference...
  Token count: 17383

| Mating Part | Found Feature | Compatible? |
| M10x1.5 SCREW | M10X1.5 | YES |
| SHAFT 25mm | 25.00 ±0.02 | YES |

FINAL VERDICT: PASS

================================================================================
KNOWN ISSUES & FIXES
================================================================================

1. Token Limit Exceeded (>32k tokens)
   - Reduced DPI from 300 to 200 for Stage 2
   - Limited OCR elements to 120
   - Limited ASME images to 3

2. CUDA Out of Memory
   - Use Runtime > Disconnect and delete runtime (not just Restart)
   - Load LightOnOCR-2 FIRST (smaller), then Qwen (larger)
   - Total VRAM needed: ~6GB (fits on most GPUs)

3. GitHub Notebook Rendering Error
   - Fixed by removing malformed widgets metadata
   - Run: Clean notebook metadata before commit

4. LightOnOCR-2 Warning ("model of type mistral3")
   - This is normal - transformers fallback behavior
   - Model works correctly despite warning

5. HuggingFace Authentication
   - Set HF_TOKEN in Colab Secrets
   - Required for model downloads

================================================================================
WORKFLOW: CLAUDE CODE <-> GOOGLE COLAB
================================================================================

1. Claude Code edits notebook locally
2. Claude pushes to GitHub: git push origin main
3. User refreshes notebook in Colab from GitHub
4. User runs updated cells
5. If errors, user saves notebook to GitHub from Colab
6. Claude pulls and checks: git fetch && git reset --hard origin/main

================================================================================
DIRECTORY STRUCTURE
================================================================================

AI-tool/
├── ai_inspector_final_fixed.ipynb    # Main notebook (push to GitHub)
├── PROJECT_RECAP.txt                  # This file
│
├── # SolidWorks extracted data (current)
├── sw_parts_db.json
├── sw_assemblies_db.json
├── sw_mating_context.json
├── sw_structure.json
├── sw_components_all.json
├── 046-935_full_tree_v2.txt
├── 046-935_mates.txt
│
├── # RAG resources
├── asme_visual_index.pkl
├── rag_visual_db/
├── ASME-Y14.5-2018-R2024...pdf
│
├── # Archived
├── old_manual_data/                   # Manual extraction (242 parts)
├── old_scripts/                       # Previous scripts
├── old_notebooks/                     # Previous notebooks
├── solidworks_tools/                  # SW macros & parsers
├── 400S_Sorted_Library/               # Organized drawings
├── PDF VAULT/                         # Drawing PDFs

================================================================================
CONTACT & REPOSITORY
================================================================================

GitHub: https://github.com/skaumbdoallsaws-coder/AI-Drawing-Inspector
Branch: main
Main File: ai_inspector_final_fixed.ipynb

================================================================================
END OF RECAP
================================================================================
